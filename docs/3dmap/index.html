<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
        <meta http-equiv="X-UA-Compatible" content="chrome=1,IE=edge"/>
        <title>10cm Lookdown map and paths for Perseverance and Ingenuity</title>
        <script type="text/javascript" src="https://www.x3dom.org/download/dev/x3dom-full.js"></script>
        <link rel="stylesheet" type="text/css" href="https://www.x3dom.org/download/dev/x3dom.css"/>
        <style>
            body {
                margin: 0px
            }

            X3D {
                width: 100%;
                height: 100%;
                background-color: black;
                filter: contrast(1.5);
            }

            .group {
            }

            .x3dom-canvas {
                cursor: crosshair;
            }

            .button {
                background: rgb(155 155 155 / 41%);
                position: absolute;
                margin: 4px;
            }

            .resetbutton {
                left: 0px;
            }

            .mapbutton {
                left: 65px;
            }

            .northbutton {
                left: 112px;
            }

            .overlookbutton {
                left: 178px;
            }

            .flightbutton {
                left: 270px;
            }

            .flight4button {
                left: 354px;
            }

            .helibutton {
                left: 438px;
            }

            .info-font {
                font-family: monospace;
                font-size: large;
                color: white;
            }

            .info {
                position: absolute;
                left: 0px;
                margin-top: 39px;
                margin-left: 4px;
                background: rgb(165 165 165 / 20%);
                padding: 5px;
            }

            .list {
                position: absolute;
                left: 0px;
                margin-top: 80px;
                margin-left: 4px;
                background: rgb(165 165 165 / 20%);
                padding: 5px;
                user-select: text;
            }

            .attribution {
                position: absolute;
                right: 0px;
                margin-right: 4px;
                background: rgb(165 165 165 / 20%);
                padding: 5px;
                bottom: 10px;
            }

            .extra-info {
                position: absolute;
                left: 0px;
                margin-left: 4px;
                background: rgb(165 165 165 / 20%);
                padding: 5px;
                bottom: 10px;
            }

            .small-font {
                font-family: monospace;
                font-size: small;
                color: white;
            }

            .sliderbox {
                position: absolute;
                left: 30px;
                margin-left: 4px;
                background: rgb(165 165 165 / 20%);
                padding: 5px;
                bottom: 50px;
                transform: rotate(270deg);
                transform-origin: left;
            }

            .atright {
                position: absolute;
                right: 0px;
                margin-right: 4px;
                background: rgb(165 165 165 / 20%);
                padding: 5px;
            }

            .contrast {
                bottom: 50px;
            }

            .help {
                top: 5px;
                max-width: 300px;
            }

            .helpText {
                display: none;
                background: rgb(0 42 78 / 31%);
                padding: 10px;
            }

            .helpList {
                list-style-type: none;
                padding: 0px;
                margin: 0px;
            }

            .mouseSVG {
                    width: 20px;
                    vertical-align: middle;
            }

            #help:checked ~ .helpText {
                    display: block
            }

            .slider {
                width: 200px;
                height: 30px;
                margin: 10px;
                form: rotate(270deg);
            }

            .sliderlabel {
                position: absolute;
                left: 50%;
                top: 0px;
                margin-top: 5px;
            }
        </style>
    </head>
    <script>
        function init() {
            deg2rad = Math.PI / 180;
            MarsR = 3396190;
            map2trueEasting = Math.cos(18.4663 * deg2rad);
            // center of landing ellipse, standard parallel
            infoDiv = document.querySelector('#infoDiv');
            listDiv = document.querySelector('#listDiv');
            labelY = document.querySelector('[for="yScale"]');
            labelContrast = document.querySelector('[for="contrast"]');
            X3D = document.querySelector('X3D');
            scaleTrafo = X3D.querySelector('#scaleTrafo');
            barTrafo = X3D.querySelector('#barTrafo');
            roverTrafo = X3D.querySelector('#roverTrafo');
            heliTrafo = X3D.querySelector('#heliTrafo');
            roverInitTrafo = X3D.querySelector('#roverInitTrafo');
            waypointsGroup = X3D.querySelector('[DEF="WAYPOINTS"]');
            waypointsURLs = {
                    "3_0"    : "https://mars.nasa.gov/news/8873/nasas-perseverance-rover-gives-high-definition-panoramic-view-of-landing-site/",
                    "3_110"  : "https://mars.nasa.gov/resources/25698/perseverance-drive-visualization/",
                    "3_386"  : "https://mars.nasa.gov/resources/25717/supercam-close-up-of-yeehgo-yeigo-target/",
                    "3_578"  : "http://www.unmannedspaceflight.com/index.php?showtopic=8608&view=findpost&p=250701",
                    "3_770"  : "http://www.unmannedspaceflight.com/index.php?showtopic=8608&view=findpost&p=250922",
                    "3_792"  : "http://www.unmannedspaceflight.com/index.php?s=&showtopic=8608&view=findpost&p=251095",
                    "3_828"  : "http://www.unmannedspaceflight.com/index.php?s=&showtopic=8608&view=findpost&p=251121",
                    "3_1266" : "https://mars.nasa.gov/news/8896/nasa-ingenuity-mars-helicopter-prepares-for-first-flight/",
                    "3_1374" : "http://www.unmannedspaceflight.com/index.php?s=&showtopic=8608&view=findpost&p=251190",
                    "3_1392" : "http://www.unmannedspaceflight.com/index.php?s=&showtopic=8610&view=findpost&p=251389",
                    "3_1398" : "http://www.unmannedspaceflight.com/index.php?s=&showtopic=8608&view=findpost&p=251367",
                    "3_1416" : "http://www.unmannedspaceflight.com/index.php?s=&showtopic=8608&view=findpost&p=251437",
                    "3_1708" : "http://www.unmannedspaceflight.com/index.php?s=&showtopic=8608&view=findpost&p=251494",
                    "3_1850" : "https://mars.nasa.gov/resources/25796/ingenuity-begins-to-spin-its-blades/",
                    "3_1950" : "http://www.unmannedspaceflight.com/index.php?s=&showtopic=8608&view=findpost&p=251540",
                    "3_2046" : "https://mars.nasa.gov/resources/25828/first-video-of-nasas-ingenuity-mars-helicopter-in-flight/",
                    "3_2150" : "https://mars.nasa.gov/news/8930/nasas-ingenuity-mars-helicopter-flies-faster-farther-on-third-flight/",
                    "3_2208" : "http://www.unmannedspaceflight.com/index.php?showtopic=8608&view=findpost&p=251943",
                    "3_2346" : "http://www.unmannedspaceflight.com/index.php?showtopic=8625&st=0&p=252044&#entry252044",
                    "3_2430" : "https://mars.nasa.gov/news/8941/nasas-perseverance-captures-video-audio-of-fourth-ingenuity-flight/"
            };
            waypointsSizes = {
                    "3_1398" : 0.3,
                    "3_1416" : 0.3
            };
            yScale = 4;
            yDatum = -2570;
            nPoints = 10;
            roverPos1 = new x3dom.fields.SFVec3f(4590876.63,1,-1093301.70);
            pointStack = [{
                pos: new x3dom.fields.SFVec3f(roverPos1.x,yDatum,roverPos1.z),
                dst: 0,
                trueDst: 0
            }];
            H = 1.97;
            // camera height

            Current_WaypointURL = "https://mars.nasa.gov/mmgis-maps/M20/Layers/json/M20_waypoints_current.json";
            All_WaypointsURL = "https://mars.nasa.gov/mmgis-maps/M20/Layers/json/M20_waypoints.json";
            TraverseURL = "https://mars.nasa.gov/mmgis-maps/M20/Layers/json/M20_traverse.json";
            //seconds
            CycleInterval = 40;
            preloadImagesUrls = [
                    "background/mirror1k/512x512-000000ff.png",
                    "background/mirror1k/py.jpg",
                    "background/mirror1k/pz.jpg",
                    "background/mirror1k/nz.jpg",
                    "background/mirror1k/px.jpg",
                    "background/mirror1k/nx.jpg" ];
            //preloadImages(preloadImagesUrls);
            initWaypointsandAnimation();
            //addWaypoints();

            //<TextureCoordinate point="0 0 1 1"></TextureCoordinate>
            //zDimension='452' xSpacing='1.000162168140152241' zDimension='452' zSpacing='1.000774557521954211'
            //translation='4590641.917 2570 -1093538.3776'>
            //calcPanoTexCoords(document.querySelector('elevationgrid'), document.querySelector('#posTrafo'), roverPos1);
        }

        function preloadImages(urls) {
            var container = document.createElement("loader");
            urls.forEach( url => container.innerHTML += `<img src="${url}" >` );
            document.body.appendChild(container);
            container.style = "display: none"; // hide after appending
            //container.remove();
        }

        async function initWaypointsandAnimation() {
            var waypointsResponse = await fetch(All_WaypointsURL);
            var waypoints;
            if ('json' in waypointsResponse )
            {
                waypoints = await waypointsResponse.json();
                waypoints.features.
                   filter(f=>f.properties.site>2).
                   forEach(f=>waypointsGroup.appendChild(wpFromFeature(f)));
            }
            else { console.warn(waypointsResponse) };
            
            var prec = 4; // precision for interpolators
            var ts = document.querySelector('[DEF=TS]');
            ts.cycleInterval = CycleInterval;
            ts.loop = true;
            var traverse = await (await fetch(TraverseURL)).json();
            traverse.features.sort((a, b) => 
                {
                    var eps = 0.000001; //0.01;
                    var aLength = a.geometry.coordinates[0][0];//a.properties.length;// 0.0 means last // || "3_999999";
                    if (aLength == 0) { return 1 };
                    var bLength = b.geometry.coordinates[0][0];//b.properties.length;// || "3_999999";
                    if (bLength == 0) { return -1 };
                    //var aIndex = waypoints.features.findIndex( f => Math.abs( f.properties.dist_m - aLength ) < eps );
                    var aIndex = waypoints.features.findIndex( f => Math.abs( f.geometry.coordinates[0] - aLength ) < eps );
                    //var bIndex = waypoints.features.findIndex( f => Math.abs( f.properties.dist_m - bLength ) < eps );                       
                    var bIndex = waypoints.features.findIndex( f => Math.abs( f.geometry.coordinates[0] - bLength ) < eps );
                    return aIndex < bIndex ? -1: 1; 
                    //parseInt(aRMC.slice(2)) < parseInt(bRMC.slice(2)) ? -1 : 1;
                });
            fillElevations(traverse, waypoints);
            var pIntp = document.querySelector('[DEF=PI]');
            var coords = traverse.features.reduce((a, f) => f.geometry ? a.concat(f.geometry.coordinates) : a, []);
            var key = coords.map((v, i)=>(0.1 + 0.8 * i / (coords.length - 1)).toFixed(prec));
            key.unshift(0);
            key.push(1);
            var keyValue = coords.map(v=>{
                return fromLatLong({
                    lon: v[0],
                    lat: v[1],
                    elev_geoid: v[2] - yDatum, //(v[2] || (yDatum+0.5)) - yDatum,
                }).map( v => v.toFixed(2) )
            }
            );
            keyValue.unshift(keyValue[0]);
            keyValue.push(keyValue[keyValue.length - 1]);
            pIntp.key = key.join();
            pIntp.keyValue = keyValue.join();
            var oIntp = document.querySelector('[DEF=OI]');
            var keyValue = coords.map((v,i)=>{
                var xyz0 = fromLatLong({
                    lon: v[0],
                    lat: v[1],
                    elev_geoid: 0
                });
                var next = (i + 1) in coords ? coords[i + 1] : v;
                var xyz1 = fromLatLong({
                    lon: next[0],
                    lat: next[1],
                    elev_geoid: 0
                });
                var dx = xyz1[0] - xyz0[0];
                var dy = xyz1[2] - xyz0[2];
                return [0, 1, 0, (-Math.atan2(dy, dx) - Math.PI / 2).toFixed(prec)]
            }
            );
            keyValue.unshift(keyValue[0]);
            keyValue.push(keyValue[keyValue.length - 1]);
            oIntp.key = key.join();
            oIntp.keyValue = keyValue.join();
            //adjust final yaw
            var waypoints = await (await fetch(Current_WaypointURL)).json();
            var yaw = waypoints.features[0].properties.yaw;
            keyValue[keyValue.length - 1] = [0, 1, 0, -yaw * deg2rad];
            keyValue[keyValue.length - 2] = [0, 1, 0, -yaw * deg2rad];
            oIntp.keyValue = keyValue.join();
            //potentially update standard parallel
            //map2trueEasting = Math.cos(waypoints.features[0].geometry.coordinates[1] * deg2rad);
        }

        function fillElevations(traverse, waypoints) {
            traverse.features.forEach( f => {
                var wFrom = waypoints.features.find( w => w.properties.RMC == f.properties.fromRMC);
                var wTo = waypoints.features.find( w => w.properties.RMC == f.properties.toRMC);
                var cFrom = wFrom && wFrom.geometry.coordinates;
                cFrom[2] = +wFrom.properties.elev_geoid;
                var cTo = wTo && wTo.geometry.coordinates;
                cTo[2] = +wTo.properties.elev_geoid;
                
                f.geometry.coordinates.forEach( c => {
                    if (c[2] == 0) 
                    {                        
                        c[2] = cFrom[2] + ( cTo[2] - cFrom[2] ) * ( c[0] - cFrom[0] ) / ( cTo[0] - cFrom[0] );  
                    }
                })
            })
        }

        function wpFromFeature(f) {
            var wp = document.createElement('WayPoint');
            var props = f.properties;
            var latlong = {
                    lon: f.geometry.coordinates[0],
                    lat: f.geometry.coordinates[1],
                    elev_geoid: props.elev_geoid
            };
            wp.setAttribute('location', fromLatLong(latlong).join());
            wp.setAttribute('text', `"sol ${props.sol}, drive ${props.drive}"`);
            if (props.RMC in waypointsSizes)
            {
                wp.setAttribute('radius', waypointsSizes[props.RMC]);
                wp.setAttribute('textSize', waypointsSizes[props.RMC]);    
            };
            if (props.RMC in waypointsURLs)
            {
                var anchor = document.createElement('Anchor');
                anchor.setAttribute('url', waypointsURLs[props.RMC]);
                anchor.appendChild(wp);
                return anchor
            }
            return wp
        }

        function fromLatLong(props) {
            var easting = props.lon * MarsR * deg2rad;
            var northing = props.lat * MarsR * deg2rad;
            var elevation = props.elev_geoid;
            return [easting, elevation, -northing]
        }

        function mousemove(e) {
            
            var location = [e.worldX, e.worldX * map2trueEasting, -e.worldZ, e.worldY / yScale + yDatum];
            var current = pointStack[0].pos;
            var az = (Math.atan2( -location[2] - current.z, location[0] - current.x ) * 180/Math.PI + 90 + 360) % 360;
            
            infoDiv.textContent = location.concat([az]).map(prettify).join(" ");   
        }

        function prettify(x) {
            return x.toFixed(2);
        }

        function mouseclick(e) {
            var prev = pointStack[0];
            var pos = new x3dom.fields.SFVec3f(e.worldX, e.worldY / yScale + yDatum, e.worldZ);
            if (prev.pos.equals(pos, 0.01)) // assume double click
            {
                pointStack.shift();
            } else {
                var dist = pos.subtract(prev.pos);
                var trueDist = new x3dom.fields.SFVec3f(dist.x * map2trueEasting,dist.y,dist.z);
                var point = {
                    pos: pos,
                    dst: dist.length(),
                    trueDst: trueDist.length()
                };
                var n = pointStack.unshift(point);
            }
            listDiv.textContent = "clicked point, true distance from last [m]:\n\n" + pointStack.slice(0, nPoints).map(ppPoint).join("\n");
            function ppPoint(p) {
                return [p.pos.x, -p.pos.z, p.pos.y, p.trueDst].map(prettify).join(' ')
            }
        }

        function scaleY(v) {
            yScale = parseFloat(v);
            labelY.textContent = yScale.toFixed(1) + ' x v.e.';
            scaleTrafo.scale = [1, yScale, 1].join();
            //roverInitTrafo.translation = [0, -4.5 + roverPos1.y * yScale, 0].join();
        }

        function applyPIHscaled (e) {
            if (e.fieldName == 'value_changed')
            {
                e.value.y *= yScale;
                heliTrafo.setFieldValue('translation', e.value);
            }
        }

        function applyPIscaled (e) {
            if (e.fieldName == 'value_changed')
            {
                e.value.y *= yScale;
                roverTrafo.setFieldValue('translation', e.value);
            }
        }

        function contrast(v) {
            var c = parseFloat(v);
            labelContrast.textContent = c.toFixed(2) + ' contrast';
            X3D.style.filter = `contrast(${c})`;
        }

        function addBladeAnimation(inline) {
                var root = inline.querySelector('transform');
                var rotor2 = inline.querySelector('[DEF=glTF_NODE_rotors_02]');//special treatment
                rotor2.setAttribute('render','false');
                rotor2.querySelectorAll('shape').forEach( function (c,i) 
                {
                        var defname = 'rotor2_shape_' + i;
                        c.setAttribute('DEF', defname);
                        //manually add to defMap since adding DEF is not supported
                        var node = c._x3domNode;
                        node._DEF = defname;
                        node._nameSpace.defMap[defname] = node;
                } );
                var rot2trafo = document.createElement('Transform');
                rot2trafo.setAttribute('DEF', 'rotor2Trafo');
                // need to clone node this way since x3dom has problems moving the rotor2 DOM node.
                rot2trafo.innerHTML = `
<Transform DEF='glTF_NODE_rotors_02_ghost' translation='${rotor2.translation}' rotation='${rotor2.rotation}' scale='${rotor2.scale}'>
  <Shape USE='rotor2_shape_0'></Shape>
  <Shape USE='rotor2_shape_1'></Shape>
  <Shape USE='rotor2_shape_2'></Shape>
  <Shape USE='rotor2_shape_3'></Shape>
</Transform>`;
                root.appendChild(rot2trafo);
                var aniContainer = document.createElement('group');
                aniContainer.innerHTML = `
<TimeSensor DEF="hts" loop="true" enabled="true" cycleInterval="0.3" first="true"></TimeSensor>
<OrientationInterpolator DEF="hOI1" key="0 0.5 1" keyValue="1 0 0 0, 1 0 0 -3.14, 1 0 0 -6.28"></OrientationInterpolator>
<OrientationInterpolator DEF="hOI2" key="0 0.5 1" keyValue="1 0 0 0, 1 0 0  3.14, 1 0 0  6.28"></OrientationInterpolator>
<ROUTE fromNode="hts" fromField="fraction_changed" toNode="hOI1" toField="set_fraction"></ROUTE>
<ROUTE fromNode="hOI1" fromField="value_changed" toNode="glTF_NODE_rotors_01" toField="set_rotation"></ROUTE>
<ROUTE fromNode="hts" fromField="fraction_changed" toNode="hOI2" toField="set_fraction"></ROUTE>
<ROUTE fromNode="hOI2" fromField="value_changed" toNode="rotor2Trafo" toField="set_rotation"></ROUTE>
<TimeSensor DEF='TSH2' loop='true' cycleInterval='80' enabled='true'></TimeSensor>
<BooleanSequencer DEF='BSQ'
     key='0     0.11  0.165  0.167  0.899  0.901      1' 
keyValue='False True  False   True  False   True  False'>
</BooleanSequencer>
<ScalarInterpolator DEF='SI' \
     key=' 0  0.1  0.166  0.9   1' 
keyValue='10    1    0.3    1  10'>
</ScalarInterpolator>
<ROUTE fromNode="TSH2" fromField="fraction_changed" toNode="BSQ" toField="set_fraction"></ROUTE>
<ROUTE fromNode="BSQ" fromField="value_changed" toNode="hts" toField="set_enabled"></ROUTE>
<ROUTE fromNode="TSH2" fromField="fraction_changed" toNode="SI" toField="set_fraction"></ROUTE>
<ROUTE fromNode="SI" fromField="value_changed" toNode="hts" toField="set_cycleInterval"></ROUTE>
`
                root.appendChild(aniContainer);
        }

        function modDEM (inline) {
            var material = inline.querySelector('Material');
            material.setAttribute('ambientintensity', '2.1');
        }

        function changeView (elementID, mode) {
                document.querySelector(elementID).bind = true;
                if (mode == "disableDrag") {
                    X3D.runtime.disableLeftDrag();
                }
                else {
                     X3D.runtime.enableLeftDrag();       
                }
        }

        // NOT USED
        function calcPanoTexCoords(grid, trafo, pos) {
            var xdim = grid.xDimension * 1.0;
            var zdim = grid.zDimension * 1.0;
            var xSpacing = grid.xSpacing * 1.0;
            var zSpacing = grid.zSpacing * 1.0;
            var prec = 7;

            var offset = trafo.getFieldValue("translation").subtract(pos);
            var height = grid.getFieldValue("height");

            var uv = [];

            for (var i = 0; i < zdim; i++) {
                for (var j = 0; j < xdim; j++) {
                    var n = j + i * xdim;
                    var h = H - (height[n] - yDatum);
                    var dx = offset.x + j * xSpacing;
                    var dy = offset.z + i * zSpacing;
                    var d = Math.sqrt(dx * dx + dy * dy);
                    var alpha = Math.atan(h / d);
                    var beta = Math.atan2(dy, dx) + 110 * Math.PI / 180;
                    var u = (0.5 + beta / (2 * Math.PI)) % 1;
                    var v = 0.5 + alpha / (Math.PI);
                    uv.push(u, v);
                    //.toFixed(prec),v.toFixed(prec));
                }
            }

            var texcoord = document.createElement('TextureCoordinate');
            texcoord.setAttribute('point', uv.join());
            grid.appendChild(texcoord);
        }
    </script>
    <body onload='init()'>
        <div class="group">
            <X3D xmlns="http://www.web3d.org/specifications/x3d-namespace" id="x3d" _disableLeftDrag='true' disableKeys='true' showStat="false" showLog="false">
                <button class="button resetbutton info-font" onclick='this.parentNode.runtime.resetView()'>RESET</button>
                <button class="button mapbutton info-font" onclick='changeView("#mapView")'>MAP</button>
                <button class="button northbutton info-font" onclick='changeView("#northView")'>NORTH</button>
                <button class="button overlookbutton info-font" onclick='changeView("#overlookView")'>OVERLOOK</button>
                <button class="button flightbutton info-font" onclick='changeView("#flightView")'>FLIGHT3</button>
                <button class="button flight4button info-font" onclick='changeView("#flight4View")'>FLIGHT4</button>
                <button class="button helibutton info-font" onclick='changeView("#heliView", "disableDrag")'>HELI</button>
                <div id='cursorinfo' class="info info-font">
                <div>X X_t Y el. az.:</div>
                <div id='infoDiv'>cursor</div>
                </div>
                <pre id='listDiv' class="list info-font">digitize points</pre>
                <div class='small-font extra-info'>Equirectangular Mars 2000 Sphere projection</div>
                <div id='attributions' class="small-font attribution">NASA/JPL-Caltech/Mars2020 HiRISE/T. Appéré (c)2021 Andreas Plesch
                </div>
                <div class='sliderbox'>
                    <input oninput="scaleY(this.value)" class='slider' type="range" id="yScale" name="yScale" step="0.1" min="1" max="9">
                    <label class='small-font sliderlabel' for="yScale">4.0 x v.e.</label>
                </div>
                <div class='atright contrast'>
                    <input oninput="contrast(this.value)" class='slider' type="range" id="contrast" name="contrast" step="0.01" min="0" max="3">
                    <label class='small-font sliderlabel' for="contrast">1.50 contrast</label>
                </div>
                <div class='atright help'>
                    <input type="checkbox" id="help" name="help">
                    <label class='small-font' for="help">help</label>
                    <div class="helpText info-font">
                        <ul class='helpList'>
                            <li>
                                <img class="mouseSVG" src="media/Mouse_1.svg"></img>
                                drag to rotate
                            </li>
                            <li>
                                <img class="mouseSVG" src="media/Mouse_2.svg"></img>
                                right drag or wheel to zoom
                            </li>
                            <li>
                                <img class="mouseSVG" src="media/Mouse_3_Scroll.svg"></img>
                                middle drag to pan
                            </li>
                            <li>
                                <img class="mouseSVG" src="media/Mouse_1.svg"></img>
                                double click to recenter
                            </li>
                            <li> 
                                <hr>
                                Use buttons on top row for alternative views. If lost, click RESET. 
                                v.e. slider adjusts vertical exaggeration. contrast slider adjusts overall image contrast.
                                Blue domes are rover way points and are linked to relevant content.
                                Rover and helicopter are at scale.
                            </li>
                        </ul>
                    </div>
                </div>
                <Scene>
                    <Environment id="gamma" gammaCorrectionDefault="none"></Environment>
                    <NavigationInfo headlight='false' type='"EXAMINE"' _explorationMode='-rotate'></NavigationInfo>
                    <WorldInfo title='animated Mars Rover Perserverance Map'></WorldInfo>
                    <ProtoDeclare name='WayPoint'>
                        <ProtoInterface>
                            <field name='location' type='SFVec3f' value='0 0 0' accessType='inputOutput'></field>
                            <field name='textOffset' type='SFVec3f' value='1 1 -1' accessType='inputOutput'></field>
                            <field name='text' type='MFString' accessType='inputOutput'></field>
                            <field name='radius' type='SFFloat' value='1.0' accessType='initializeOnly'></field>
                            <field name='textSize' type='SFFloat' value='1.0' accessType='initializeOnly'></field>
                            <field name='color' type='SFColor' value='0.2 0.6 1' accessType='inputOutput'></field>
                            <field name='justify' type='MFString' value='"BEGIN" "MIDDLE"' accessType='initializeOnly'></field>
                            <field name='style' type='SFString' value='BOLD' accessType='initializeOnly'></field>
                            <field name='family' type='MFString' value='"SERIF"' accessType='initializeOnly'></field>
                        </ProtoInterface>
                        <ProtoBody>
                            <Transform>
                                <IS>
                                    <connect nodeField='translation' protoField='location'></connect>
                                </IS>
                                <Transform rotation='1 0 0 -1.57'>
                                <IS>
                                    <connect nodeField='translation' protoField='textOffset'></connect>
                                </IS>
                                        <Shape>
                                            <Appearance>
                                                <Material>
                                                    <IS>
                                                        <connect nodeField='diffuseColor' protoField='color'></connect>
                                                    </IS>
                                                </Material>
                                            </Appearance>
                                            <Text solid='false'>
                                                <IS>
                                                    <connect nodeField='string' protoField='text'></connect>
                                                </IS>
                                                <FontStyle>
                                                    <IS>
                                                        <connect nodeField='family' protoField='family'></connect>
                                                        <connect nodeField='justify' protoField='justify'></connect>
                                                        <connect nodeField='size' protoField='textSize'></connect>
                                                        <connect nodeField='style' protoField='style'></connect>
                                                    </IS>
                                                </FontStyle>
                                            </Text>
                                        </Shape>
                                </Transform>
                                <Shape>
                                    <Appearance>
                                        <Material transparency='0.8'>
                                            <IS>
                                                <connect nodeField='diffuseColor' protoField='color'></connect>
                                            </IS>
                                        </Material>
                                    </Appearance>
                                    <Sphere usegeocache='false'>
                                        <IS>
                                            <connect nodeField='radius' protoField='radius'></connect>
                                        </IS>
                                    </Sphere>
                                </Shape>
                            </Transform>
                        </ProtoBody>
                    </ProtoDeclare>
                    <Background DEF='back1'
                            bottomUrl='"background/mirror1k/512x512-000000ff.png"'
                            topUrl='"background/mirror1k/py.jpg"'
                            frontUrl='"background/mirror1k/pz.jpg"'
                            backUrl='"background/mirror1k/nz.jpg"'
                            leftUrl='"background/mirror1k/px.jpg"'
                            rightUrl='"background/mirror1k/nx.jpg"'>
                    </Background>
                    <DirectionalLight direction='-1, -0.5, -1' ambientintensity='0.4'></DirectionalLight>
                    <PointLight DEF='heliLight' location='4590883 6 -1093313' radius='4' ambientintensity='0'></PointLight>
                    <!-- physicalenvironmentlight diffuse="https://x3dom.org/download/assets/pbr/papermillDiffuse.dds"
                                          specular="https://x3dom.org/download/assets/pbr/papermillSpecular.dds">
                    </physicalenvironmentlight -->
                    <Viewpoint id="mapView" position="4590884 215 -1093312" orientation="1 0 0 -1.57" centerOfRotation="4590884 0 -1093314" fieldOfView="0.52" description="Map view"></Viewpoint>
                    <Viewpoint id="northView" position="4590891 72 -1093226" orientation="-0.99951 0.01929 -0.02464 0.67771" centerOfRotation="4590889 4 -1093301" fieldOfView="0.52" description="Perspective to N"></Viewpoint>
                    <Viewpoint id="overlookView" position="4590974 13.63 -1093305" orientation="-0.06809 0.99339 0.09241 1.48611" centerOfRotation="4590883.38941 0 -1093313.61735" fieldOfView="0.78" description="Van Zyl Overlook"></Viewpoint>
	                <Viewpoint id="flightView" position="4590914 68.2 -1093294" orientation="-0.81461 0.50662 0.28237 1.11329" centerOfRotation="4590885 0.4 -1093338" fieldOfView="0.52" description="Flight view"></Viewpoint>
	                <Viewpoint id="flight4View" position="4590974 62.5 -1093118" orientation="-0.71431 0.69753 0.05675 0.60154" centerOfRotation="4590900 3.35 -1093243" fieldOfView="0.52" description="Flight4 view"></Viewpoint>
	                
	                <Transform id='scaleTrafo' scale='1 4 1'>
                        <Transform onmousemove='mousemove(event)' onclick='mouseclick(event)' id='posTrafo' translation='4590641.917 2570 -1093538.3776'>
                            <Inline onload='modDEM(this)' namespacename='dem' url='M20_elevationgridA.x3d'></Inline>
                        </Transform>
                        <Transform DEF='WAYPOINTS' translation='0 2570 0'></Transform>
                        <Transform DEF='SITES' translation='0 2570 0'>
                                <WayPoint text='"Octavia E. Butler""Landing"' color='0 0 0' radius='0.2' textOffset='-3.5 1 -3' location='4590876 -2570 -1093299'></WayPoint>
                                <WayPoint text='Wright Brothers Field' color='0 0 0' radius='0.2' textOffset='-3.5 1 -1' location='4590884 -2570 -1093315.24'></WayPoint>
                                <WayPoint text='Van Zyl Overlook' color='0 0 0' radius='0.2' textOffset='1 1 1' location='4590952.15 -2569 -1093307.40'></WayPoint>
                        </Transform>
                        <Transform DEF='FlightZone' translation='4590869.6 0 -1093372.5'>
                                <Shape>
                                        <!-- be sure to order cross-section points so that normal is upward -->
                                        <Extrusion solid='false' crossSection='
0.0,0.0 0.0,-1.4 0.2,-2.9 0.5,-4.3 0.9,-5.7 1.5,-7.1 2.2,-8.3 3.1,-9.5 4.1,-10.6 5.2,-11.6 6.3,-12.5 7.6,-13.2 9.0,-13.8 10.3,-14.3 11.8,-14.6 13.2,-14.7 14.7,-14.7 16.2,-14.6 17.6,-14.3 19.0,-13.8 20.3,-13.2 21.6,-12.5 22.8,-11.6 23.9,-10.7 24.9,-9.6 25.7,-8.4 26.5,-7.1 27.1,-5.8 27.5,-4.4 27.8,-3.0 28.0,-1.5 31.2,58.0 31.2,59.4 31.1,60.9 30.8,62.3 30.3,63.7 29.7,65.1 29.0,66.3 28.2,67.5 27.2,68.6 26.1,69.6 24.9,70.5 23.6,71.2 22.3,71.8 20.9,72.3 19.5,72.6 18.0,72.7 16.6,72.7 15.1,72.6 13.7,72.3 12.3,71.8 10.9,71.2 9.7,70.5 8.5,69.6 7.4,68.7 6.4,67.6 5.5,66.4 4.8,65.1 4.2,63.8 3.7,62.4 3.4,61.0 3.3,59.5 0.0,0.0                                        ' 
                                                spine='0 0 0, 0 1 0'
                                                beginCap = 'false' endCap = 'false'
                                                >
                                        <!-- spine is open, crossSection is closed -->
                                        </Extrusion>
                                        <Appearance>
                                                <Material transparency='0.9' ambientIntensity='0.1'
                                                diffuseColor='0.2 0.6 0.5' emissiveColor='0.2 0.6 0.5'>
                                                </Material>
                                        </Appearance>
                                </Shape>
                        </Transform>
                        
                    </Transform>
                    <Transform id='roverTrafo' DEF='roverTrafo' translation='4590876.63 0 -1093299.70' rotation='0 1 0 -2.29'>
                                                <Viewpoint id='roverView' position='0, 2, 0' orientation='1,0,0,-0.1'></Viewpoint>

                        <Transform id='roverInitTrafo' translation='0 0.1 0' _rotation='1 0 0 1.57' rotation='0 1 0 3.1415'>
                            <Inline namespacename='rover' _url='Perseverance_v2.glb' url='Perseverance_stowed.glb' __url='Perseverance.glb'></Inline>
                        </Transform>
                    </Transform>
                    <Transform id='heliTrafo' DEF='heliTrafo' translation='4590885.87,4,-1093313.659' rotation='0 1 0 0'>
                    
                        <Transform id='heliCam' DEF='heliCam' rotation='0 1 0 3.14'>
                            <Viewpoint id='heliView' position='0, 1, 0' orientation='1,0,0,-0.1'></Viewpoint>
                        </Transform>        
                    
                        <Inline onload='addBladeAnimation(this)' id='heliModel' namespacename='heli' url='Ingenuity_v3.glb'></Inline>
                    
                    </Transform>
                    
                    <TimeSensor DEF='TSH' loop='true' cycleInterval='80' enabled='true'></TimeSensor>
                    <PositionInterpolator DEF='PIH' onoutputchange='applyPIHscaled(event)'
                    key='
                    0 0.05 0.066 0.11 0.22 0.28 0.3 0.33
                    0.338 0.5 0.52 0.64 0.65 0.666
                    0.68 0.83 0.84 0.86 0.92 1.0'
                    keyValue='
                    4590885.87 0.0 -1093313.659,
                    4590885.87 0.0 -1093313.659,
                    4590885.87 5.2 -1093313.659,
                    4590883.13 5.2 -1093363,
                    4590883.13 5.2 -1093363,
                    4590883.42 5.2 -1093313.659,
                    4590883.42 0.0 -1093313.659,
                    4590883.42 0.0 -1093313.659,

                    4590883.42 5.2 -1093313.659,
                    4590901.31 6.2 -1093185.31,
                    4590901.31 6.2 -1093185.31,
                    4590893.95 5.2 -1093314.08,
                    4590893.95 0.2 -1093314.08,
                    4590893.95 0.2 -1093314.08,

                    4590893.95 5.2 -1093314.08,
                    4590908.31 6.2 -1093185.31,
                    4590908.31 11.2 -1093185.31,
                    4590908.31 11.2 -1093185.31,
                    4590908.31 1.1 -1093185.31
                    4590908.31 1.1 -1093185.31 
                    '></PositionInterpolator>
                    <OrientationInterpolator DEF='OIH' key='0 0.166 0.2 0.43 0.56 0.83 0.9 1' keyValue='
                    0 1 0 0
                    0 1 0 0
                    0 1 0 0
                    0 1 0 0
                    0 1 0 -1.57
                    0 1 0 -1.57
                    0 1 0 -1.57
                    0 1 0 -1.57
                    '></OrientationInterpolator>
                    <ROUTE fromNode='TSH' fromField='fraction_changed' toNode='PIH' toField='set_fraction'></ROUTE>
                    <!-- now script
                    <ROUTE fromNode='PIH' fromField='value_changed' toNode='heliTrafo' toField='set_translation'></ROUTE>
                    -->
                    <ROUTE fromNode='TSH' fromField='fraction_changed' toNode='OIH' toField='set_fraction'></ROUTE>
                    <ROUTE fromNode='OIH' fromField='value_changed' toNode='heliTrafo' toField='set_rotation'></ROUTE>
                    <TimeSensor DEF='TS' loop='false' cycleInterval='20' enabled='true'></TimeSensor>
                    <PositionInterpolator DEF='PI' onoutputchange='applyPIscaled(event)'
                    key='0 0.2 0.4 0.6 0.8 1' 
                    keyValue='
                    4590876.63 0.5 -1093299.70,
                    4590876.63 0.5 -1093301.70,
                    4590880.59 0.5 -1093297.35,
                    4590880.59 0.5 -1093297.35,
                    4590880.87 0.5 -1093294.80,
                    4590880.87 0.5 -1093294.80
                    '></PositionInterpolator>
                    <OrientationInterpolator DEF='OI' key='0 0.2 0.4 0.6 0.8 1' keyValue='
                    0 1 0 0
                    0 1 0 0
                    0 1 0 0
                    0 1 0 2.6179
                    0 1 0 2.6179
                    0 1 0 2.6179
                    '></OrientationInterpolator>
                    <ROUTE fromNode='TS' fromField='fraction_changed' toNode='PI' toField='set_fraction'></ROUTE>
                    <!-- now script
                    <ROUTE fromNode='PI' fromField='value_changed' toNode='roverTrafo' toField='set_translation'></ROUTE>
                    -->
                    <ROUTE fromNode='TS' fromField='fraction_changed' toNode='OI' toField='set_fraction'></ROUTE>
                    <ROUTE fromNode='OI' fromField='value_changed' toNode='roverTrafo' toField='set_rotation'></ROUTE>
                </Scene>
            </X3D>
        </div>
    </body>
</html>

